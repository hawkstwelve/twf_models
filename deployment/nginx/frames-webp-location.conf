# Insert this location block inside the `server { ... }` block that serves api.sodakweather.com.
# Place it before generic proxy/static handlers so `/frames/...` resolves directly to published artifacts.
location ~ ^/frames/(?<model>[a-z0-9_-]+)/(?<run>\d{8}_\d{2}z)/(?<var>[a-z0-9_-]+)/(?<fh>\d{3})\.webp$ {
    alias /data/published/$model/$run/$var/frames/$fh.webp;
    default_type image/webp;

    # When the request carries a content-hash version token (?v=<hex>),
    # the response is immutable.  Without a token the content may be
    # refreshed during progressive publish, so use a short cache.
    set $cc "public, max-age=60, stale-while-revalidate=300";
    if ($arg_v ~ "^[a-f0-9]{12,64}$") {
        set $cc "public, max-age=31536000, immutable";
    }
    add_header Cache-Control $cc always;
    add_header Access-Control-Allow-Origin "*" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;
}
